%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% mhfig.sty, v1.6 Copyright 2002 by Martin Hairer
%
% This package is to be used together with GrapherLibrary
%
% The graphicx and color packages are required for mhfig to work
% In order to use the "mhwrap" environment, wrapfig is required
%
% Syntax:
%
%   \mhpastefig[p/q](path){Fig}
%
%	p/q : ratio at which the figure is displayed (default : 1/1)
%       path : An optional path to be appended at the beginning of Fig.
%	Fig : the file Fig.inp/Fig.ps are generated by GrapherLibrary
%
%       This command allows to place the figure Fig wherever you want
%       (for example inside an equation if the command is placed inside
%       an array environment).
%
%
%   \begin{mhfig}[p/q](path){Fig}[vspace]
%     \caption{}
%   \end{mhfig}
%
%	p/q : ratio at which the figure is displayed (default : 1/1)
%       path : An optional path to be appended at the beginning of Fig.
%	Fig : the file Fig.inp/Fig.ps are generated by GrapherLibrary
%	vspace: Vertical space to be placed before the figure (default : 0mm)
%
%
%   \begin{mhwrap}[n]{pos}{hsize}[p/q](path){Fig}[vspace]
%     \caption{}
%   \end{mhwrap}
%
%       n   : Number of narrow lines (same option as for wrapfigure)
%	pos : position of the figure (r or l)
%	hsize : horizontal size of the figure
%	p/q : ratio at which the figure is displayed (default : 1/1)
%       path : An optional path to be appended at the beginning of Fig.
%	Fig : the files Fig.inp/Fig.ps are generated by GrapherLibrary
%	vspace: Vertical space to be placed before the figure (default : 0mm)
%
% If you do not want to have separate "fig.inp" files for each figure, you
% can comment the lines containing the \@MHinput command and copy instead the
% content of the "fig.inp" file into the mhfig or mhwrap environment.
% This does not work for the \mhpastefig command.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ProvidesPackage{mhfig}
\RequirePackage{graphicx}
\RequirePackage{color}

\def\mhpastefig{\@ifnextchar[{\@MHpastegetrapp}{\@MHpastegetrapp[1/1]}}
\def\@MHpastegetrapp[#1/#2]{\@ifnextchar({\@MHpastefig[#1/#2]}{\@MHpastefig[#1/#2]()}}
\def\@MHpastefig[#1/#2](#3)#4{\global\def\scalep{#1}%
\global\def\scaleq{#2}\xdef\path{#3}\@MHinput{#4.inp}}

\def\mhfig{\figure[h]\@ifnextchar[{\@getpath}{\@getpath[1/1]}}
\def\@getpath[#1/#2]{\@ifnextchar({\@figargs[#1/#2]}{\@figargs[#1/#2]()}}
\def\@figargs[#1/#2](#3)#4{%
	\@ifnextchar[{\@figdim{#1}{#2}{#3}{#4}}{\@fignodim{#1}{#2}{#3}{#4}}%
	}
\def\@figdim#1#2#3#4[#5]{\vspace{#5}\@fig{#1}{#2}{#3}{#4}}
\def\@fignodim#1#2#3#4{\@fig{#1}{#2}{#3}{#4}}
\def\@fig#1#2#3#4{%
	\global\def\scalep{#1}%
	\global\def\scaleq{#2}%
	\xdef\path{#3}%
	\begin{center}%
	%
	%
	\@MHinput{#4.inp}%%% This line may be commented
	%
	%
	\end{center}%
	}
\def\endmhfig{\endfigure}
\def\mhwrap{\@ifnextchar[{\@MHwrap}{\@MHwrap[-1]}}
\def\@MHwrap[#1]#2#3{\wrapfigure[#1]{#2}{#3}\@ifnextchar[{\@wrappath}{\@wrappath[1/1]}}
\def\@wrappath[#1/#2]{\@ifnextchar({\@wrapargs[#1/#2]}{\@wrapargs[#1/#2]()}}
\def\@wrapargs[#1/#2](#3)#4{%
	\@ifnextchar[{\@wrapdim{#1}{#2}{#3}{#4}}{\@wrapnodim{#1}{#2}{#3}{#4}}%
	}
\def\@wrapdim#1#2#3#4[#5]{\vspace{#5}\@wrap{#1}{#2}{#3}{#4}}
\def\@wrapnodim#1#2#3#4{\@wrap{#1}{#2}{#3}{#4}}
\def\@wrap#1#2#3#4{%
	\global\def\scalep{#1}%
	\global\def\scaleq{#2}%
	\xdef\path{#3}
	\begin{center}%
	%
	%
	\@MHinput{#4.inp}%%% This line may be commented
	%
	%
	\end{center}%
	}
\def\endmhwrap{\endwrapfigure}
\global\def\scalep{1}
\global\def\scaleq{1}

\def\@whitesqr#1#2#3{%
\fboxsep0pt%
\definecolor{tempc}{rgb}{#3}%
\colorbox{tempc}{\hbox to #1{\hss\vbox to #2{\vss}}}%
}

\def\@MHputB[#1,#2](#3)#4(#5,#6)#7[#8]{%
  \setbox\MHbox\vbox{\hbox{#7}\kern0pt}%
  \MHlength\wd\MHbox\@tempdima\MHlength%
  \divide\MHlength by1000 \multiply\MHlength by#1%
  \MHheight\ht\MHbox\@tempdimb\MHheight%
  \divide\MHheight by-1000 \multiply\MHheight by#2%
  \advance\MHheight\@tempdimb%
  \advance\@tempdima#4\advance\@tempdima#4%
  \advance\@tempdimb#4\advance\@tempdimb#4%
  \setbox\@tempboxa\hbox{\vbox to 0mm{\vss \hbox to 0mm{\kern-#4\@whitesqr{\@tempdima}{\@tempdimb}{#3}\hss}\kern-#4}%
	\box\MHbox}%
  \setbox\@tempboxa\vbox to 0cm{\kern-\MHheight\hbox{\kern-\MHlength\box\@tempboxa}\vss}%
  \put(#5,#6){\rotatebox{#8}{\box\@tempboxa}}%
  }
\def\MHputB{\@ifnextchar[{\@MHputB}{\@MHputB[0,0]}}
\def\@MHput[#1,#2](#3,#4)#5[#6]{%
  \setbox\MHbox\vbox{\hbox{#5}\kern0pt}%
  \MHlength\wd\MHbox\@tempdima\MHlength%
  \divide\MHlength by1000 \multiply\MHlength by#1%
  \MHheight\ht\MHbox\@tempdimb\MHheight%
  \divide\MHheight by-1000 \multiply\MHheight by#2%
  \advance\MHheight\@tempdimb%
  \setbox\@tempboxa\vbox to 0cm{\kern-\MHheight\hbox{\kern-\MHlength\box\MHbox}\vss}%
  \put(#3,#4){\rotatebox{#6}{\box\@tempboxa}}%
  }
\def\MHput{\@ifnextchar[{\@MHput}{\@MHput[0,0]}}
\def\@MHinput#1{\input{\path#1}}
\def\MHepsfig#1#2{\includegraphics[width=#2]{\path#1}}

\newdimen\MHpointsize
\newdimen\MHpicturesize
\newdimen\MHlength
\newdimen\MHheight
\newdimen\MHBoxlength
\newdimen\MHBoxheight
\newbox\MHbox
\newbox\MHcopy
